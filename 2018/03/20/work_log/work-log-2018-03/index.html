<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Work Log," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 年后的每一天都有周一综合征.">
<meta name="keywords" content="Work Log">
<meta property="og:type" content="article">
<meta property="og:title" content="工作日志(2018-03)">
<meta property="og:url" content="http://yoursite.com/2018/03/20/work_log/work-log-2018-03/index.html">
<meta property="og:site_name" content="Congspark">
<meta property="og:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 年后的每一天都有周一综合征.">
<meta property="og:image" content="http://yoursite.com/images/work-log-2018-03/pic01.png">
<meta property="og:image" content="http://yoursite.com/images/work-log-2018-03/pic02.png">
<meta property="og:image" content="http://yoursite.com/images/work-log-2018-03/pic03.png">
<meta property="og:image" content="http://yoursite.com/images/work-log-2018-03/pic04.png">
<meta property="og:image" content="http://yoursite.com/images/work-log-2018-03/pic05.png">
<meta property="og:updated_time" content="2018-03-21T02:53:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="工作日志(2018-03)">
<meta name="twitter:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 年后的每一天都有周一综合征.">
<meta name="twitter:image" content="http://yoursite.com/images/work-log-2018-03/pic01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/03/20/work_log/work-log-2018-03/"/>





  <title> 工作日志(2018-03) | Congspark </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?bce8cb320afbfc1f884cd356da4e3a62";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Congspark</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">from journeyman to master</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/20/work_log/work-log-2018-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shao Cheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Congspark">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                工作日志(2018-03)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-20T16:14:17+08:00">
                2018-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Work-Log/" itemprop="url" rel="index">
                    <span itemprop="name">Work Log</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Work-Log/2018/" itemprop="url" rel="index">
                    <span itemprop="name">2018</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/03/20/work_log/work-log-2018-03/" class="leancloud_visitors" data-flag-title="工作日志(2018-03)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&nbsp;&nbsp;&nbsp;&nbsp; 年后的每一天都有周一综合征.</p>
<a id="more"></a>
<h3 id="Tuesday-20th"><a href="#Tuesday-20th" class="headerlink" title="Tuesday 20th"></a>Tuesday 20th</h3><p>&nbsp;&nbsp;&nbsp;&nbsp; 这次总结关于 gradle, 第一次研究, 踩了好多坑.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 这两天一直在研究 <code>Grade</code> 的相关内容, 源于一个优化需求: 我们公司的产品的版本号分为五段(别问我为什么, 就是这么任性..) 例如, “1.1.1.1.002”. 可以理解为 <code>product.major.minor.patch.custom</code>. 其中 <code>product</code> 表示的是产品线, <code>custom</code> 表示的是内部号, 仅在团队内部, 开发和测试童鞋间使用.<br>&nbsp;&nbsp;&nbsp;&nbsp; 产品的童鞋是这么要求的, 每次给我们 .apk 包(也就是 release 版的包)的时候, <code>custom</code> 字段自动增加(姑且先自动加一吧). 这个样子就不需要手动去设置了.<br>&nbsp;&nbsp;&nbsp;&nbsp; 跟大神讨论了一下, <code>Gradle</code> 无所不能, 肯定是可以实现的, 于是乎屁颠屁颠的查官方文档.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 这里附上链接. <a href="https://docs.gradle.org/current/userguide/userguide.html" target="_blank" rel="external">Gradle 官方文档</a>. 里面有一个 Android 的专栏. 这里没有直接给出 Android 专栏的地址, 因为文档会维护更新, url 也会变化.<br>&nbsp;&nbsp;&nbsp;&nbsp; 官方文档仅仅是对 Android 项目中使用的 <code>build.gradle</code> 文件做了一个简单的介绍, 并没有深入. 但是给出了参考资料. <a href="https://gradle.org/books/?_ga=2.227217949.1877343065.1521440367-1557908144.1500443106" target="_blank" rel="external">Gradle Recipes for Android, by Ken Kousen and published by O’Reilly Media, Inc</a> 相当于 <code>Grade</code> 文档在 Android 项目中的是用详解. 这个也是我的主要参考资料, 写的很不错, 毕竟是官方人员提供.<br>&nbsp;&nbsp;&nbsp;&nbsp; 还有一本参考书, 人气博主飞雪无情的 &lt;&lt;Android Gradle权威指南&gt;&gt;, 还有他的博客 <a href="http://www.flysnow.org/2017/03/12/android-gradle-auto-version.html" target="_blank" rel="external">Android Gradle 实用技巧(二) 自动生成版本信息</a>.  但是个人感觉写的一般, 对新人不友好, 我觉得这本书称之为 &lt;&lt;Android Gradle 权威总结&gt;&gt; 比较合适, 并不是指南.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 回到刚才的需求问题. 飞雪无情的博客中已经给出了具体的思路:<br>&nbsp;&nbsp;&nbsp;&nbsp; 大致如下:</p>
<ol>
<li>在项目目录下新建一个 <code>version.properties</code> 的属性文件。</li>
<li>把版本名称分成三部分 <code>major.minor.patch</code>，版本号分成一部分number，然后在 <code>version.properties</code> 中新增四个KV键值对，其key就是我们上面分好的 <code>major</code>，<code>minor</code>，<code>patch</code> 以及 <code>number</code>，<code>value</code> 是对应的值。</li>
<li>然后在 <code>build.gradle</code> 里新建两个方法，用于读取该属性文件，获取对应Key的值，然后把major.minor.patch这三个key拼接成版本名称，<code>number</code> 用于版本号。</li>
<li>以上就达到了获取版本信息的目的，获取使用之后，我们还要更新我们存放在 <code>version.properties</code> 文件中的信息，这样就可以达到版本自增的目的，以供下次使用。</li>
<li>在更新版本名称三部分的时候，你可以自定义自己的逻辑，是逢10高位+1呢，还是其他算法，都可以自己灵活定义。</li>
<li>使用版本信息，更新 <code>version.properties</code> 文件的时机，记得 <code>doLast</code> 这个方法。</li>
<li>记得不会在自己运行调试的时候让你的版本信息自增哦，如何控制呢？就是要区分是真正的打包发版，还是平时的调试、测试，有很多办法来区分的。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp; (观其大略, 不要在乎那几个字段, 我直接 copy 过来了)但是, 比较恶心的是, 他并没有给出实现的代码, 需要自己来搞.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 首先建立文件, 这个没什么问题.</p>
<div align="center"><br><img src="/images/work-log-2018-03/pic01.png" width="500" height="100"><br></div>

<p>&nbsp;&nbsp;&nbsp;&nbsp; 接着是相关读取和修改文件的方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">task autoChangeVersionCode &#123;</div><div class="line">    <span class="comment">// Properties 是操作 .properties 文件的工具类.</span></div><div class="line">    Properties versionProperties = <span class="keyword">new</span> Properties()</div><div class="line">    <span class="comment">// 加载 version.properties 文件, project 对应的是当前项目.</span></div><div class="line">    versionProperties.load(project.file(<span class="string">'version.properties'</span>).newInputStream())</div><div class="line">    <span class="comment">// 读取 custom 对应的字段</span></div><div class="line">    def custom = versionProperties.getProperty(<span class="string">'custom'</span>)</div><div class="line">    <span class="comment">// 然后更新字段</span></div><div class="line">    versionProperties.setProperty(<span class="string">'custom'</span>, ++custom)</div><div class="line"></div><div class="line">    <span class="comment">// 将 properties 中的内容写回文件中去. 这时踩到的第一个坑.</span></div><div class="line">    versionProperties.store(project.file(<span class="string">'version.properties'</span>).newOutputStream())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 终端执行一下 <code>gradlew autoChangeVersionCode</code> (可以不区分大小写),结果没什么问题.</p>
<blockquote>
<p><strong>NOTE</strong>: 这么写并不准确, 仅仅是为了测试. 该 autoChangeVersionCode 任务是一个 配置任务, 也就是官方文档中说的 Configuration 类型的任务. 如果不加 <code>doLast</code>, 则任何 task 执行, 都会执行该任务. 因为执行 task 之前, 需要走一遍完整的配置. 参考的具体的官方文档, 也就是官方提供的那本书:  <br></p>
<p>If you don’t want to simply configure an existing Gradle task, you need to understand the distinction between the con guration and execution phases of Gradle. During the configuration phase, Gradle builds a DAG based on their dependencies. It then exe‐ cutes the desired task, along with its dependencies. All tasks are configured before any are executed.<br>&nbsp;&nbsp;&nbsp;&nbsp; — from Gradle Receipt for Android. 4.1 Writing your own custom tasks</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 最后一个亟待解决的问题, 如何去调用这个方法, 应该是在执行 <code>assembleRelease</code> 方法之后, 自动执行 <code>autoChangeVersionCode</code> 任务, 参考项目中原有的修改 .apk 文件名的相关代码.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 修改打包的文件</span></div><div class="line">android.applicationVariants.all &#123; variant -&gt;</div><div class="line">    variant.outputs.all &#123;</div><div class="line">        <span class="keyword">if</span> (variant.buildType.name == <span class="string">'release'</span>) &#123;</div><div class="line">            <span class="comment">// 重新定义 .apk 文件名.</span></div><div class="line">            def newName = variant.name + <span class="string">"_"</span> + getCustomVersionName() + <span class="string">"_"</span> + releaseTime + <span class="string">".apk"</span></div><div class="line">            outputFileName = <span class="keyword">new</span> File(newName)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 觉得这是一个可以使用的方式.</span></div><div class="line">android.applicationVariants.with&#123;</div><div class="line">     <span class="comment">// 更新 version.properties 中的相关逻辑.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>NOTE</strong>: 通常上述代码写在, <code>buildType{ }</code> 的 <code>release { }</code> 中, 提示该任务是跟集成 release 版本的安装包有关. 作为一个根 task 也没有问题.</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 但是, 将更新 <code>version.properties</code> 文件的逻辑放在 <code>android.applicationVariants.with</code> 中, 不管是执行 <code>assembleDebug</code> 或者是 <code>assembleRelease</code> 操作, 都会触发修改版本号的逻辑.<br>&nbsp;&nbsp;&nbsp;&nbsp; 小小的心塞了一下, 然后写了两个测试任务, 执行的时候发现 <code>android.appliationVariants.with</code> 中的逻辑仍然会执行, 也就说, <code>android.appliationVariants.with</code> 中的任务是一个配置任务, 不管执行什么任务都会触发执行.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 好吧, <code>android.applicationVariants.with</code> 是搞不定这个问题了…..<br>&nbsp;&nbsp;&nbsp;&nbsp; <a href="">Gradle Recipes for Android</a> 第四章关于 gradle 任务有一个关于 copy task 的描述. (直接截图了)</p>
<div align="center"><br><img src="/images/work-log-2018-03/pic02.png" width="800" height="100"><br></div>

<div align="center"><br><img src="/images/work-log-2018-03/pic03.png" width="800" height="100"><br></div>

<div align="center"><br><img src="/images/work-log-2018-03/pic04.png" width="800" height="100"><br></div>

<p>&nbsp;&nbsp;&nbsp;&nbsp; 其中说明, 如果想让一个 build 任务(其他的系统任务也是可以的)执行时, copy 任务也执行, 那么可以使用这种方式定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">build.dependsOn copyApks</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 那么举一反三一下, 换成 <code>assembleRelease.dependsOn autoChangeVersionCode</code> 是不是就可以了? 尝试一下, 结果, 任性的 gradle 秒秒钟给你报错.</p>
<div align="center"><br><img src="/images/work-log-2018-03/pic05.png" width="700" height="100"><br></div>

<p>&nbsp;&nbsp;&nbsp;&nbsp; 无奈, 只好去问 google, Stack Overflow 中给出了一种添加系统任务依赖的方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tasks.whenTaskAdded &#123; theTask -&gt;</div><div class="line">    <span class="comment">// 根据任务名定位具体任务.</span></div><div class="line">    <span class="keyword">if</span> (theTask.name.equals(<span class="string">'assembleRelease'</span>)) &#123;</div><div class="line">        theTask.dependsOn autoChangeVersionCode</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 然后尝试了一下, 完美!!!<br>&nbsp;&nbsp;&nbsp;&nbsp; 下面贴出具体的代码.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取当前打包时间. 格式 "3-10-10h", 三月10日 10点.</span></div><div class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getReleaseTime</span><span class="params">()</span> </span>&#123;</div><div class="line">    def cal = Calendar.getInstance()</div><div class="line">    def strDate = (cal.get(Calendar.MONTH) + <span class="number">1</span>) + <span class="string">"-"</span> +</div><div class="line">            cal.get(Calendar.DAY_OF_MONTH) + <span class="string">"-"</span> +</div><div class="line">            cal.get(Calendar.HOUR_OF_DAY) + <span class="string">"h"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 获取版本号信息</span></div><div class="line"><span class="function">def String <span class="title">getCustomVersionName</span><span class="params">()</span> </span>&#123;</div><div class="line">    Properties versionProperties = <span class="keyword">new</span> Properties()</div><div class="line">    versionProperties.load(project.file(<span class="string">'version.properties'</span>).newInputStream())</div><div class="line">    def versionName = <span class="string">"$&#123;versionProperties.getProperty('major')&#125;."</span> +</div><div class="line">            <span class="string">"$&#123;versionProperties.getProperty('minor')&#125;."</span> +</div><div class="line">            <span class="string">"$&#123;versionProperties.getProperty('patch')&#125;."</span> +</div><div class="line">            <span class="string">"$&#123;versionProperties.getProperty('number')&#125;."</span> +</div><div class="line">            <span class="string">"$&#123;versionProperties.getProperty('custom')&#125;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 修改打包文件的文件名</span></div><div class="line">android.applicationVariants.all &#123; variant -&gt;</div><div class="line">    variant.outputs.all &#123;</div><div class="line">        <span class="comment">// 只有在发布 release 版本的时候, 才会修改文件名</span></div><div class="line">        <span class="keyword">if</span> (variant.buildType.name == <span class="string">'release'</span>) &#123;</div><div class="line">            def newName = variant.name + <span class="string">"_"</span> + getCustomVersionName() + <span class="string">"_"</span> + releaseTime + <span class="string">".apk"</span></div><div class="line">            outputFileName = <span class="keyword">new</span> File(newName)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 定义一个 task, 属于 build 分组.</span></div><div class="line">Task autoChangeVersionCode = task(autoChangeVersionCode, group: BasePlugin.BUILD_GROUP)</div><div class="line"></div><div class="line"><span class="comment">// 修改版本号的 task, 记得 doLast 方法</span></div><div class="line">autoChangeVersionCode.doLast &#123;</div><div class="line">    Properties versionProperties = <span class="keyword">new</span> Properties()</div><div class="line">    versionProperties.load(project.file(<span class="string">'version.properties'</span>).newInputStream())</div><div class="line">    def custom = versionProperties.getProperty(<span class="string">'custom'</span>)</div><div class="line">    versionProperties.setProperty(<span class="string">'custom'</span>, ++custom)</div><div class="line">    versionProperties.store(project.file(<span class="string">'version.properties'</span>).newOutputStream(), <span class="string">'increase version code'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 添加任务依赖, 当执行 assembleRelease 任务时, autoChangeVersionCode 任务也会执行.</span></div><div class="line">tasks.whenTaskAdded &#123; theTask -&gt;</div><div class="line">    <span class="keyword">if</span> (theTask.name.equals(<span class="string">'assembleRelease'</span>)) &#123;</div><div class="line">        theTask.dependsOn autoChangeVersionCode</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>NOTE</strong>: 需要注意一点的是, 上面的逻辑会先执行 assembleRelease 任务, 然后再去执行版本号加一的任务.</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 小结: 深刻的体会到除了官方文档, 其余的参考资料基本上都是坑, 而且时效性很差(这一点也是源于 gradle 没有做老版本的兼容). Gradle 和 Groovy 其实也是 Java, 只不过是对 build.gradle 文件做相应的解析, 生成相应的任务和命令.<br>&nbsp;&nbsp;&nbsp;&nbsp;</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>~感谢捧场，您的支持将鼓励我继续创作~</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.png" alt="Shao Cheng WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.jpeg" alt="Shao Cheng Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Work-Log/" rel="tag"># Work Log</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/14/git/git-summery/" rel="next" title="Git - 总结篇">
                <i class="fa fa-chevron-left"></i> Git - 总结篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/07/work_log/work-log-2018-05/" rel="prev" title="工作日志(2018-05)">
                工作日志(2018-05) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Shao Cheng" />
          <p class="site-author-name" itemprop="name">Shao Cheng</p>
           
              <p class="site-description motion-element" itemprop="description">Talk less, Think more</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">57</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tuesday-20th"><span class="nav-number">1.</span> <span class="nav-text">Tuesday 20th</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shao Cheng</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("IVOziuThoLlJneucTgk2EdIh-gzGzoHsz", "4LA70tV2pHILaxLV1M3ja9Sl");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

</body>
</html>
